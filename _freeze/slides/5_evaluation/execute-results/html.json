{
  "hash": "a25051e6ce85c96326e2fcd68a5c681d",
  "result": {
    "markdown": "---\ntitle: Evaluation\ntitle-slide-attributes:\n  data-background-image: ../images/logo.png\n  data-background-size: contain\n  data-background-opacity: \"0.5\"\nlang: en\nsubtitle: LangChain Basics 5\nauthor: Jan Kirenz\nexecute:\n  eval: false\n  echo: true\nhighlight-style: github\nformat:\n  revealjs: \n    toc: true\n    toc-depth: 1\n    embed-resources: false\n    theme: [dark, ../custom.scss]  \n    incremental: true\n    transition: slide\n    background-transition: fade\n    transition-speed: slow\n    code-copy: true\n    code-line-numbers: true\n    smaller: false\n    scrollable: true\n    slide-number: c\n    preview-links: auto\n    chalkboard: \n      buttons: false\n   # logo: ../images/logo.png\n    footer: Jan Kirenz\n---\n\n# LangChain: Evaluation\n\nExample generation, Manual evaluation (and debuging), LLM-assisted evaluation & LangChain evaluation platform\n\n# Setup\n\n## Python\n\n::: {.cell execution_count=1}\n``` {.python .cell-code}\nfrom langchain.evaluation.qa import QAEvalChain\nimport langchain\nfrom langchain.evaluation.qa import QAGenerateChain\nfrom langchain.vectorstores import DocArrayInMemorySearch\nfrom langchain.indexes import VectorstoreIndexCreator\nfrom langchain.document_loaders import CSVLoader\nfrom langchain.chat_models import ChatOpenAI\nfrom langchain.chains import RetrievalQA\nimport datetime\nimport os\n\nfrom dotenv import load_dotenv, find_dotenv\n_ = load_dotenv(find_dotenv())\n```\n:::\n\n\n# Q and A Application\n\n## Load data\n\n::: {.cell execution_count=2}\n``` {.python .cell-code}\nfile = '../data/OutdoorClothingCatalog_1000.csv'\nloader = CSVLoader(file_path=file)\ndata = loader.load()\n```\n:::\n\n\n- Vector store\n\n. . .\n\n::: {.cell execution_count=3}\n``` {.python .cell-code}\nindex = VectorstoreIndexCreator(\n    vectorstore_cls=DocArrayInMemorySearch\n).from_loaders([loader])\n```\n:::\n\n\n## Retrieval QA chain\n\n::: {.cell execution_count=4}\n``` {.python .cell-code}\nllm_model = \"gpt-3.5-turbo\"\n\nllm = ChatOpenAI(temperature=0.0, model=llm_model)\n\nqa = RetrievalQA.from_chain_type(\n    llm=llm,\n    chain_type=\"stuff\",\n    retriever=index.vectorstore.as_retriever(),\n    verbose=True,\n    chain_type_kwargs={\n        \"document_separator\": \"<<<<>>>>>\"\n    }\n)\n```\n:::\n\n\n# Test Datapoints Manually\n\n- We use our data and come up with relevant questions\n\n## Datapoint 1 {.smaller}\n\n::: {.cell execution_count=5}\n``` {.python .cell-code}\ndata[10]\n```\n:::\n\n\n- `Output`: Document(page_content=\": 10\\nname: Cozy Comfort Pullover Set, Stripe\\ndescription: Perfect for lounging, this striped knit set lives up to its name. We used ultrasoft fabric and an easy design that's as comfortable at bedtime as it is when we have to make a quick run out.\\n\\nSize & Fit\\n- Pants are Favorite Fit: Sits lower on the waist.\\n- Relaxed Fit: Our most generous fit sits farthest from the body.\\n\\nFabric & Care\\n- In the softest blend of 63% polyester, 35% rayon and 2% spandex.\\n\\nAdditional Features\\n- Relaxed fit top with raglan sleeves and rounded hem.\\n- Pull-on pants have a wide elastic waistband and drawstring, side pockets and a modern slim leg.\\n\\nImported.\", metadata={'source': '../data/OutdoorClothingCatalog_1000.csv', 'row': 10})\n\n## Datapoint 2 {.smaller}\n\n::: {.cell execution_count=6}\n``` {.python .cell-code}\ndata[11]\n```\n:::\n\n\n- `Output`: Document(page_content=': 11\\nname: Ultra-Lofty 850 Stretch Down Hooded Jacket\\ndescription: This technical stretch down jacket from our DownTek collection is sure to keep you warm and comfortable with its full-stretch construction providing exceptional range of motion. With a slightly fitted style that falls at the hip and best with a midweight layer, this jacket is suitable for light activity up to 20¬∞ and moderate activity up to -30¬∞. The soft and durable 100% polyester shell offers complete windproof protection and is insulated with warm, lofty goose down. Other features include welded baffles for a no-stitch construction and excellent stretch, an adjustable hood, an interior media port and mesh stash pocket and a hem drawcord. Machine wash and dry. Imported.', metadata={'source': '../data/OutdoorClothingCatalog_1000.csv', 'row': 11})\n\n## Hard-coded example questions\n\n::: {.cell execution_count=7}\n``` {.python .cell-code}\nexamples = [\n    {\n        \"query\": \"Do the Cozy Comfort Pullover Set\\\n        have side pockets?\",\n        \"answer\": \"Yes\"\n    },\n    {\n        \"query\": \"What collection is the Ultra-Lofty \\\n        850 Stretch Down Hooded Jacket from?\",\n        \"answer\": \"The DownTek collection\"\n    }\n]\n```\n:::\n\n\n# LLM-Generated examples\n\n- Automate evaluation with a llM\n\n## QAGenerateChain\n\n- Generate questions and answer pairs\n\n::: {.cell execution_count=8}\n``` {.python .cell-code}\nexample_gen_chain = QAGenerateChain.from_llm(ChatOpenAI(model=llm_model))\n```\n:::\n\n\n. . .\n\n- Create dictionary with question and answer pair\n\n::: {.cell execution_count=9}\n``` {.python .cell-code}\n# the warning can be safely ignored\nnew_examples = example_gen_chain.apply_and_parse(\n    [{\"doc\": t} for t in data[:5]]\n)\n```\n:::\n\n\n## New examples\n\n::: {.cell execution_count=10}\n``` {.python .cell-code}\nnew_examples[0]\n```\n:::\n\n\n- `Output`: {'query': \"What is the weight of one pair of Women's Campside Oxfords?\",\n 'answer': \"The approximate weight of one pair of Women's Campside Oxfords is 1 lb. 1 oz.\"}\n\n## Original data {.smaller}\n\n::: {.cell execution_count=11}\n``` {.python .cell-code}\ndata[0]\n```\n:::\n\n\n- `Output`: Document(page_content=\": 0\\nname: Women's Campside Oxfords\\ndescription: This ultracomfortable lace-to-toe Oxford boasts a super-soft canvas, thick cushioning, and quality construction for a broken-in feel from the first time you put them on. \\n\\nSize & Fit: Order regular shoe size. For half sizes not offered, order up to next whole size. \\n\\nSpecs: Approx. weight: 1 lb.1 oz. per pair. \\n\\nConstruction: Soft canvas material for a broken-in feel and look. Comfortable EVA innersole with Cleansport NXT¬Æ antimicrobial odor control. Vintage hunt, fish and camping motif on innersole. Moderate arch contour of innersole. EVA foam midsole for cushioning and support. Chain-tread-inspired molded rubber outsole with modified chain-tread pattern. Imported. \\n\\nQuestions? Please contact us for any inquiries.\", metadata={'source': '../data/OutdoorClothingCatalog_1000.csv', 'row': 0})\n\n# QA Chain\n\n## Combine examples\n\n::: {.cell execution_count=12}\n``` {.python .cell-code}\nexamples += new_examples\n```\n:::\n\n\n. . .\n\n::: {.cell execution_count=13}\n``` {.python .cell-code}\nqa.run(examples[0][\"query\"])\n```\n:::\n\n\n- `Output`: 'Yes, the Cozy Comfort Pullover Set does have side pockets.'\n\n- Very litte information about the process in the output\n\n## Langchain debug\n\n- We set `.debug=True`to get more information\n\n. . .\n\n::: {.cell execution_count=14}\n``` {.python .cell-code}\nlangchain.debug = True\n```\n:::\n\n\n- Rerun the same application and take a look at your output\n\n. . .\n\n::: {.cell execution_count=15}\n``` {.python .cell-code}\nqa.run(examples[0][\"query\"])\n```\n:::\n\n\n. . .\n\n```bash\n[chain/start] [1:chain:RetrievalQA] Entering Chain run with input:\n{\n  \"query\": \"Do the Cozy Comfort Pullover Set        have side pockets?\"\n}\n[chain/start] [1:chain:RetrievalQA > 3:chain:StuffDocumentsChain] Entering Chain run with input:\n[inputs]\n[chain/start] [1:chain:RetrievalQA > 3:chain:StuffDocumentsChain > 4:chain:LLMChain] Entering Chain run with input:\n{\n  \"question\": \"Do the Cozy Comfort Pullover Set        have side pockets?\",\n  \"context\": \": 10\\nname: Cozy Comfort Pullover Set, Stripe\\ndescription: Perfect for lounging, this striped knit set lives up to its name. We used ultrasoft fabric and an easy design that's as comfortable at bedtime as it is when we have to make a quick run out.\\n\\nSize & Fit\\n- Pants are Favorite Fit: Sits lower on the waist.\\n- Relaxed Fit: Our most generous fit sits farthest from the body.\\n\\nFabric & Care\\n- In the softest blend of 63% polyester, 35% rayon and 2% spandex.\\n\\nAdditional Features\\n- Relaxed fit top with raglan sleeves and rounded hem.\\n- Pull-on pants have a wide elastic waistband and drawstring, side pockets and a modern slim leg.\\n\\nImported.<<<<>>>>>: 73\\nname: Cozy Cuddles Knit Pullover Set\\ndescription: Perfect for lounging, this knit set lives up to its name. We used ultrasoft fabric and an easy design that's as comfortable at bedtime as it is when we have to make a quick run out. \\n\\nSize & Fit \\nPants are Favorite Fit: Sits lower on the waist. \\nRelaxed Fit: Our most generous fit sits farthest from the body. \\n\\nFabric & Care \\nIn the softest blend of 63% polyester, 35% rayon and 2% spandex.\\n\\nAdditional Features \\nRelaxed fit top with raglan sleeves and rounded hem. \\nPull-on pants have a wide elastic waistband and drawstring, side pockets and a modern slim leg. \\nImported.<<<<>>>>>: 632\\nname: Cozy Comfort Fleece Pullover\\ndescription: The ultimate sweater fleece ‚Äì made from superior fabric and offered at an unbeatable price. \\n\\nSize & Fit\\nSlightly Fitted: Softly shapes the body. Falls at hip. \\n\\nWhy We Love It\\nOur customers (and employees) love the rugged construction and heritage-inspired styling of our popular Sweater Fleece Pullover and wear it for absolutely everything. From high-intensity activities to everyday tasks, you'll find yourself reaching for it every time.\\n\\nFabric & Care\\nRugged sweater-knit exterior and soft brushed interior for exceptional warmth and comfort. Made from soft, 100% polyester. Machine wash and dry.\\n\\nAdditional Features\\nFeatures our classic Mount Katahdin logo. Snap placket. Front princess seams create a feminine shape. Kangaroo handwarmer pockets. Cuffs and hem reinforced with jersey binding. Imported.\\n\\n ‚Äì Official Supplier to the U.S. Ski Team\\nTHEIR WILL TO WIN, WOVEN RIGHT IN. LEARN MORE<<<<>>>>>: 151\\nname: Cozy Quilted Sweatshirt\\ndescription: Our sweatshirt is an instant classic with its great quilted texture and versatile weight that easily transitions between seasons. With a traditional fit that is relaxed through the chest, sleeve, and waist, this pullover is lightweight enough to be worn most months of the year. The cotton blend fabric is super soft and comfortable, making it the perfect casual layer. To make dressing easy, this sweatshirt also features a snap placket and a heritage-inspired Mt. Katahdin logo patch. For care, machine wash and dry. Imported.\"\n}\n[llm/start] [1:chain:RetrievalQA > 3:chain:StuffDocumentsChain > 4:chain:LLMChain > 5:llm:ChatOpenAI] Entering LLM run with input:\n{\n  \"prompts\": [\n    \"System: Use the following pieces of context to answer the users question. \\nIf you don't know the answer, just say that you don't know, don't try to make up an answer.\\n----------------\\n: 10\\nname: Cozy Comfort Pullover Set, Stripe\\ndescription: Perfect for lounging, this striped knit set lives up to its name. We used ultrasoft fabric and an easy design that's as comfortable at bedtime as it is when we have to make a quick run out.\\n\\nSize & Fit\\n- Pants are Favorite Fit: Sits lower on the waist.\\n- Relaxed Fit: Our most generous fit sits farthest from the body.\\n\\nFabric & Care\\n- In the softest blend of 63% polyester, 35% rayon and 2% spandex.\\n\\nAdditional Features\\n- Relaxed fit top with raglan sleeves and rounded hem.\\n- Pull-on pants have a wide elastic waistband and drawstring, side pockets and a modern slim leg.\\n\\nImported.<<<<>>>>>: 73\\nname: Cozy Cuddles Knit Pullover Set\\ndescription: Perfect for lounging, this knit set lives up to its name. We used ultrasoft fabric and an easy design that's as comfortable at bedtime as it is when we have to make a quick run out. \\n\\nSize & Fit \\nPants are Favorite Fit: Sits lower on the waist. \\nRelaxed Fit: Our most generous fit sits farthest from the body. \\n\\nFabric & Care \\nIn the softest blend of 63% polyester, 35% rayon and 2% spandex.\\n\\nAdditional Features \\nRelaxed fit top with raglan sleeves and rounded hem. \\nPull-on pants have a wide elastic waistband and drawstring, side pockets and a modern slim leg. \\nImported.<<<<>>>>>: 632\\nname: Cozy Comfort Fleece Pullover\\ndescription: The ultimate sweater fleece ‚Äì made from superior fabric and offered at an unbeatable price. \\n\\nSize & Fit\\nSlightly Fitted: Softly shapes the body. Falls at hip. \\n\\nWhy We Love It\\nOur customers (and employees) love the rugged construction and heritage-inspired styling of our popular Sweater Fleece Pullover and wear it for absolutely everything. From high-intensity activities to everyday tasks, you'll find yourself reaching for it every time.\\n\\nFabric & Care\\nRugged sweater-knit exterior and soft brushed interior for exceptional warmth and comfort. Made from soft, 100% polyester. Machine wash and dry.\\n\\nAdditional Features\\nFeatures our classic Mount Katahdin logo. Snap placket. Front princess seams create a feminine shape. Kangaroo handwarmer pockets. Cuffs and hem reinforced with jersey binding. Imported.\\n\\n ‚Äì Official Supplier to the U.S. Ski Team\\nTHEIR WILL TO WIN, WOVEN RIGHT IN. LEARN MORE<<<<>>>>>: 151\\nname: Cozy Quilted Sweatshirt\\ndescription: Our sweatshirt is an instant classic with its great quilted texture and versatile weight that easily transitions between seasons. With a traditional fit that is relaxed through the chest, sleeve, and waist, this pullover is lightweight enough to be worn most months of the year. The cotton blend fabric is super soft and comfortable, making it the perfect casual layer. To make dressing easy, this sweatshirt also features a snap placket and a heritage-inspired Mt. Katahdin logo patch. For care, machine wash and dry. Imported.\\nHuman: Do the Cozy Comfort Pullover Set        have side pockets?\"\n  ]\n}\n[llm/end] [1:chain:RetrievalQA > 3:chain:StuffDocumentsChain > 4:chain:LLMChain > 5:llm:ChatOpenAI] [1.20s] Exiting LLM run with output:\n{\n  \"generations\": [\n    [\n      {\n        \"text\": \"Yes, the Cozy Comfort Pullover Set does have side pockets.\",\n        \"generation_info\": null,\n        \"message\": {\n          \"lc\": 1,\n          \"type\": \"constructor\",\n          \"id\": [\n            \"langchain\",\n            \"schema\",\n            \"messages\",\n            \"AIMessage\"\n          ],\n          \"kwargs\": {\n            \"content\": \"Yes, the Cozy Comfort Pullover Set does have side pockets.\",\n            \"additional_kwargs\": {}\n          }\n        }\n      }\n    ]\n  ],\n  \"llm_output\": {\n    \"token_usage\": {\n      \"prompt_tokens\": 732,\n      \"completion_tokens\": 14,\n      \"total_tokens\": 746\n    },\n    \"model_name\": \"gpt-3.5-turbo\"\n  },\n  \"run\": null\n}\n[chain/end] [1:chain:RetrievalQA > 3:chain:StuffDocumentsChain > 4:chain:LLMChain] [1.20s] Exiting Chain run with output:\n{\n  \"text\": \"Yes, the Cozy Comfort Pullover Set does have side pockets.\"\n}\n[chain/end] [1:chain:RetrievalQA > 3:chain:StuffDocumentsChain] [1.20s] Exiting Chain run with output:\n{\n  \"output_text\": \"Yes, the Cozy Comfort Pullover Set does have side pockets.\"\n}\n[chain/end] [1:chain:RetrievalQA] [5.15s] Exiting Chain run with output:\n{\n  \"result\": \"Yes, the Cozy Comfort Pullover Set does have side pockets.\"\n}\n```\n\n## Turn of debug mode\n\n::: {.cell execution_count=16}\n``` {.python .cell-code}\n# Turn off the debug mode\nlangchain.debug = False\n```\n:::\n\n\n## Limitations\n\n- Only possible for relatively simple applications\n- In the next section, we take a look at an automated approach\n\n# LLM Assisted Evaluation\n\nLet's use a LLM for semantic evaluation\n\n## QAEvalChain\n\n- Get predictions for our examples\n\n. . .\n\n::: {.cell execution_count=17}\n``` {.python .cell-code}\npredictions = qa.apply(examples)\n```\n:::\n\n\n. . .\n\n- Create chain with LLM\n\n::: {.cell execution_count=18}\n``` {.python .cell-code}\nllm = ChatOpenAI(temperature=0, model=llm_model)\n\neval_chain = QAEvalChain.from_llm(llm)\n```\n:::\n\n\n- Call evaluate\n\n. . .\n\n::: {.cell execution_count=19}\n``` {.python .cell-code}\ngraded_outputs = eval_chain.evaluate(examples, predictions)\n```\n:::\n\n\n## QAEvalChain\n\n- Loop through examples\n\n::: {.cell execution_count=20}\n``` {.python .cell-code}\nfor i, eg in enumerate(examples):\n    print(f\"Example {i}:\")\n    print(\"Question: \" + predictions[i]['query'])\n    print(\"Real Answer: \" + predictions[i]['answer'])\n    print(\"Predicted Answer: \" + predictions[i]['result'])\n    print(\"Predicted Grade: \" + graded_outputs[i]['text'])\n    print()\n```\n:::\n\n\n. . .\n\n```markdown\n\nExample 0:\nQuestion: Do the Cozy Comfort Pullover Set        have side pockets?\nReal Answer: Yes\nPredicted Answer: Yes, the Cozy Comfort Pullover Set does have side pockets.\nPredicted Grade: CORRECT\n\nExample 1:\nQuestion: What collection is the Ultra-Lofty         850 Stretch Down Hooded Jacket from?\nReal Answer: The DownTek collection\nPredicted Answer: The Ultra-Lofty 850 Stretch Down Hooded Jacket is from the DownTek collection.\nPredicted Grade: CORRECT\n\nExample 2:\nQuestion: What is the weight of one pair of Women's Campside Oxfords?\nReal Answer: The approximate weight of one pair of Women's Campside Oxfords is 1 lb. 1 oz.\nPredicted Answer: The weight of one pair of Women's Campside Oxfords is approximately 1 lb. 1 oz.\nPredicted Grade: CORRECT\n\nExample 3:\nQuestion: What are the dimensions of the medium-sized Recycled Waterhog Dog Mat, Chevron Weave?\nReal Answer: The dimensions of the medium-sized Recycled Waterhog Dog Mat, Chevron Weave are 22.5\" x 34.5\".\nPredicted Answer: The dimensions of the medium-sized Recycled Waterhog Dog Mat, Chevron Weave are 22.5\" x 34.5\".\nPredicted Grade: CORRECT\n\nExample 4:\n...\nReal Answer: The fabric composition of the EcoFlex 3L Storm Pants is 100% nylon, exclusive of trim.\nPredicted Answer: The fabric composition of the EcoFlex 3L Storm Pants is 100% nylon, exclusive of trim.\nPredicted Grade: CORRECT\n\n```\n\n## Graded outputs\n\n::: {.cell execution_count=21}\n``` {.python .cell-code}\ngraded_outputs[0]\n```\n:::\n\n\n- {'text': 'CORRECT'}\n\n\n\n# Acknowledgments\n\n*This tutorial is mainly based on the excellent course [\"LangChain for LLM Application Development\"](https://www.deeplearning.ai/short-courses/langchain-for-llm-application-development/) provided by Harrison Chase and Andrew Ng*\n\n# What's next? {background-image=\"../images/logo.png\" background-opacity=\"0.5\"}\n\n- **Congratulations! You have completed this tutorial** üëç\n\n**Next, you may want to go back to the [lab's website](https://kirenz.github.io/langchain-basics/)**\n\n",
    "supporting": [
      "5_evaluation_files"
    ],
    "filters": [],
    "includes": {}
  }
}